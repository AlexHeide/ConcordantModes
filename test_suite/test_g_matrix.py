import os
import shutil
import numpy as np
from concordantmodes.ted import TED
from numpy.linalg import inv
from numpy import linalg as LA

from concordantmodes.g_matrix import GMatrix
from concordantmodes.options import Options
from concordantmodes.s_vectors import SVectors
from concordantmodes.zmat import Zmat

# s_vec_test = SVectors()
os.chdir("./ref_data/s_vec_test/")
options = Options()
options.coords = "Custom"
ZMAT = Zmat(options)
output_test = ZMAT.zmat_read("zmat")
ZMAT.zmat_process(output_test)

ZMAT.zmat_calc()

ZMAT.zmat_compile()
os.chdir("../../")

s_vec = SVectors(ZMAT, options, ZMAT.variable_dictionary_init)


def test_compute_G():
    errors = []
    s_vec.run(ZMAT.cartesians_init, True)

    g_mat = GMatrix(ZMAT, s_vec, options)
    g_mat.run()

    G_ref = [
        [
            8.0012137615603e-05,
            -1.3271575551779305e-05,
            -1.733387277515177e-05,
            -1.7333872897079462e-05,
            -1.0262858491426793e-05,
            -2.1260412042957635e-05,
            -2.044784880636926e-05,
            -2.0447848822377254e-05,
            2.050539044712075e-05,
            2.340080666512997e-05,
            2.0505330568028897e-05,
            -1.8049669809042293e-05,
            0.0,
            -5.137747303285723e-05,
            -1.7308696413998932e-05,
            5.4010678107746935e-06,
            -2.5961314170422233e-09,
        ],
        [
            -1.3271575551779305e-05,
            0.0005900355754683851,
            -1.4296399976875763e-05,
            -1.4296279289868913e-05,
            0.0,
            -1.6292755159873015e-05,
            1.7544477664565044e-05,
            1.7544405257325707e-05,
            -2.0989613421619362e-05,
            1.9300123114007502e-05,
            -2.0989632670269403e-05,
            -1.629275514571284e-05,
            2.594512669330084e-05,
            1.0730911266116662e-05,
            4.959929686615391e-05,
            -0.0005615385366782627,
            2.1609435239652588e-09,
        ],
        [
            -1.7333872775151766e-05,
            -1.4296399976875763e-05,
            0.0005900355754683851,
            -1.4721182334209907e-05,
            0.0,
            1.8433880582941456e-05,
            -1.5754625096282426e-05,
            2.054168342368301e-05,
            -2.1102894790400542e-05,
            -2.092089186448742e-05,
            1.9438242561740824e-05,
            7.522131964582088e-06,
            4.341172451650754e-06,
            3.17762621716839e-05,
            -1.4017888370536908e-05,
            2.6181713203942453e-05,
            -1.8146596330623064e-05,
        ],
        [
            -1.7333872897079462e-05,
            -1.4296279289868911e-05,
            -1.4721182334209909e-05,
            0.000590035575468385,
            0.0,
            1.843381589313283e-05,
            2.0541683419093525e-05,
            -1.5754625077674366e-05,
            1.9438218689788703e-05,
            -2.0920891823399122e-05,
            -2.1102914101490155e-05,
            7.523239255073045e-06,
            -2.8299953438556667e-05,
            1.104975389722228e-05,
            -1.4017888403005002e-05,
            2.618338574208273e-05,
            1.814602470303704e-05,
        ],
        [
            -1.0262858491426793e-05,
            0.0,
            0.0,
            0.0,
            0.0005786177282398213,
            -1.2188293424714131e-05,
            5.819367397391361e-06,
            5.820224040417905e-06,
            0.0,
            0.0,
            0.0,
            -1.21882934353071e-05,
            4.388377292663178e-06,
            0.0,
            1.080350807690325e-05,
            -0.0006197256445261426,
            2.991547433194623e-10,
        ],
        [
            -2.1260412042957635e-05,
            -1.6292755159873028e-05,
            1.8433880582941456e-05,
            1.843381589313283e-05,
            -1.2188293424714131e-05,
            0.00015526410888330538,
            1.008508543952807e-06,
            1.0085615875097403e-06,
            -6.794042099459433e-05,
            -2.488577842880496e-05,
            -6.79402046312875e-05,
            1.5608885155873942e-05,
            -1.56356767012444e-05,
            0.00011927711813279471,
            -2.0087614882258678e-05,
            0.00012250075098736954,
            -1.1021854279237378e-09,
        ],
        [
            -2.044784880636926e-05,
            1.7544477664565044e-05,
            -1.575462509628243e-05,
            2.0541683419093525e-05,
            5.819367397391361e-06,
            1.0085085439528074e-06,
            0.00015520882343367156,
            -1.1222974340903128e-06,
            -6.0337703483407956e-05,
            -7.600865517366864e-05,
            -2.5515387417627363e-05,
            -7.795574097321637e-06,
            -1.0405652447103298e-05,
            0.00014260659345690754,
            7.594651121357994e-05,
            -2.4145470627047546e-05,
            2.8008179958126333e-05,
        ],
        [
            -2.0447848822377254e-05,
            1.7544405257325704e-05,
            2.054168342368301e-05,
            -1.5754625077674373e-05,
            5.820224040417904e-06,
            1.0085615875097409e-06,
            -1.1222974340903137e-06,
            0.00015520882403137544,
            -2.551541360763238e-05,
            -7.600865532329724e-05,
            -6.0337452894797025e-05,
            -7.796721662299592e-06,
            2.6430038156938102e-05,
            0.00012480369839812272,
            7.594651198836133e-05,
            -2.4146993451759332e-05,
            -2.8005291134191855e-05,
        ],
        [
            2.0505390447120745e-05,
            -2.098961342161936e-05,
            -2.1102894790400532e-05,
            1.9438218689788703e-05,
            0.0,
            -6.794042099459435e-05,
            -6.0337703483407956e-05,
            -2.5515413607632378e-05,
            0.0002839473088468378,
            -5.7351027699044386e-05,
            -5.8823204099762735e-05,
            5.852667037014427e-06,
            -0.00014193838994173605,
            -0.00018983104882002412,
            -0.000130294100057612,
            -1.8110994940382714e-05,
            -9.755707717910233e-05,
        ],
        [
            2.340080666512997e-05,
            1.9300123114007502e-05,
            -2.0920891864487406e-05,
            -2.0920891823399095e-05,
            0.0,
            -2.488577842880496e-05,
            -7.600865517366864e-05,
            -7.600865532329722e-05,
            -5.7351027699044386e-05,
            0.0002826175832834053,
            -5.735123067765544e-05,
            -1.0155659570280554e-05,
            0.00012889720459738848,
            -0.0001931550427801955,
            0.00010829065350976893,
            -3.5346560114459564e-05,
            3.858622492198788e-10,
        ],
        [
            2.0505330568028897e-05,
            -2.0989632670269383e-05,
            1.943824256174082e-05,
            -2.1102914101490152e-05,
            0.0,
            -6.794020463128752e-05,
            -2.5515387417627366e-05,
            -6.0337452894797025e-05,
            -5.8823204099762735e-05,
            -5.7351230677655424e-05,
            0.00028394725269720067,
            5.851907014140411e-06,
            1.6286126867698458e-06,
            -1.4590390338594749e-05,
            -0.00013029402235180076,
            -1.812122873375579e-05,
            9.755470684841173e-05,
        ],
        [
            -1.8049669809042293e-05,
            -1.629275514571284e-05,
            7.522131964582086e-06,
            7.523239255073045e-06,
            -1.2188293435307112e-05,
            1.5608885155873942e-05,
            -7.795574097321635e-06,
            -7.796721662299592e-06,
            5.852667037014427e-06,
            -1.0155659570280552e-05,
            5.851907014140411e-06,
            0.00019133151970435303,
            -1.2570096248807384e-05,
            1.6284297574780148e-06,
            -2.3433878879794683e-05,
            9.422913841752193e-05,
            2.418454708401888e-09,
        ],
        [
            0.0,
            2.5945126693300836e-05,
            4.341172451650734e-06,
            -2.829995343855667e-05,
            4.388377292663178e-06,
            -1.5635676701244395e-05,
            -1.0405652447103298e-05,
            2.6430038156938102e-05,
            -0.00014193838994173605,
            0.00012889720459738848,
            1.6286126867698469e-06,
            -1.2570096248807388e-05,
            0.00037613629694090286,
            1.0251162103899167e-05,
            0.00012861526676663816,
            -4.148813184774717e-05,
            -0.00022347079576791963,
        ],
        [
            -5.137747303285723e-05,
            1.0730911266116658e-05,
            3.177626217168388e-05,
            1.104975389722228e-05,
            0.0,
            0.00011927711813279471,
            0.00014260659345690754,
            0.0001248036983981227,
            -0.00018983104882002412,
            -0.0001931550427801955,
            -1.4590390338594742e-05,
            1.6284297574780152e-06,
            1.0251162103899164e-05,
            0.00037493739117634066,
            7.775738820738629e-05,
            5.9588043719045846e-05,
            4.98764558273634e-05,
        ],
        [
            -1.7308696413998932e-05,
            4.95992968661539e-05,
            -1.4017888370536903e-05,
            -1.401788840300501e-05,
            1.0803508076903249e-05,
            -2.0087614882258678e-05,
            7.594651121357994e-05,
            7.594651198836133e-05,
            -0.000130294100057612,
            0.00010829065350976895,
            -0.00013029402235180076,
            -2.3433878879794683e-05,
            0.00012861526676663813,
            7.775738820738629e-05,
            0.00023654061975152612,
            -7.601420558958855e-05,
            3.0217477204859694e-09,
        ],
        [
            5.4010678107746935e-06,
            -0.0005615385366782627,
            2.618171320394245e-05,
            2.618338574208273e-05,
            -0.0006197256445261426,
            0.00012250075098736954,
            -2.4145470627047546e-05,
            -2.4146993451759332e-05,
            -1.8110994940382717e-05,
            -3.5346560114459564e-05,
            -1.8121228733755784e-05,
            9.422913841752193e-05,
            -4.148813184774717e-05,
            5.9588043719045846e-05,
            -7.601420558958856e-05,
            0.001272209473442481,
            -1.5228821651948497e-08,
        ],
        [
            -2.5961314170422233e-09,
            2.160943523965261e-09,
            -1.8146596330623064e-05,
            1.8146024703037042e-05,
            2.991547433194621e-10,
            -1.1021854279237376e-09,
            2.800817995812633e-05,
            -2.8005291134191855e-05,
            -9.755707717910233e-05,
            3.858622492198789e-10,
            9.755470684841173e-05,
            2.4184547084018885e-09,
            -0.00022347079576791963,
            4.98764558273634e-05,
            3.0217477204859694e-09,
            -1.5228821651948497e-08,
            0.0003840024568232716,
        ],
    ]

    if np.setdiff1d(np.array(G_ref), np.array(g_mat.G.tolist())).size:
        errors.append("Computed G-matrix does not match the reference.")

    assert not errors, "errors occured:\n{}".format("\n".join(errors))


test_compute_G()
