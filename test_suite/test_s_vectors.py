import os
import shutil
import numpy as np
from concordantmodes.ted import TED
from numpy.linalg import inv
from numpy import linalg as LA

from concordantmodes.options import Options
from concordantmodes.s_vectors import SVectors
from concordantmodes.zmat import Zmat

# s_vec_test = SVectors()
os.chdir("./ref_data/s_vec_test/")
options = Options()
options.coords = "Custom"
ZMAT = Zmat(options)
output_test = ZMAT.zmat_read("zmat")
ZMAT.zmat_process(output_test)

ZMAT.zmat_calc()

ZMAT.zmat_compile()
os.chdir("../../")

s_vec = SVectors(ZMAT, options, ZMAT.variable_dictionary_init)


def test_compute_B():
    errors = []
    s_vec.run(ZMAT.cartesians_init, True)

    B_ref = [
        [
            -0.9985411813969008,
            -0.05399545401680508,
            1.8621929491165038e-08,
            0.9985411813969008,
            0.05399545401680508,
            -1.8621929491165038e-08,
            -0.0,
            0.0,
            -0.0,
            -0.0,
            -0.0,
            0.0,
            -0.0,
            -0.0,
            -0.0,
            0.0,
            -0.0,
            -0.0,
        ],
        [
            0.3415577087474985,
            -0.9398608035627904,
            3.900596035723895e-05,
            0.0,
            0.0,
            0.0,
            -0.3415577087474985,
            0.9398608035627904,
            -3.900596035723895e-05,
            -0.0,
            -0.0,
            0.0,
            -0.0,
            -0.0,
            -0.0,
            0.0,
            -0.0,
            -0.0,
        ],
        [
            0.3547641089202045,
            0.4616317820419334,
            -0.8130427570742159,
            0.0,
            0.0,
            0.0,
            -0.0,
            0.0,
            -0.0,
            -0.3547641089202045,
            -0.4616317820419334,
            0.8130427570742159,
            -0.0,
            -0.0,
            -0.0,
            0.0,
            -0.0,
            -0.0,
        ],
        [
            0.35476071141213306,
            0.4616952225503889,
            0.813008215894836,
            0.0,
            0.0,
            0.0,
            -0.0,
            0.0,
            -0.0,
            -0.0,
            -0.0,
            0.0,
            -0.35476071141213306,
            -0.4616952225503889,
            -0.813008215894836,
            0.0,
            -0.0,
            -0.0,
        ],
        [
            -0.0,
            -0.0,
            0.0,
            -0.35031845615046736,
            0.9366306525410988,
            8.879876174528086e-07,
            -0.0,
            0.0,
            -0.0,
            -0.0,
            -0.0,
            0.0,
            -0.0,
            -0.0,
            -0.0,
            0.35031845615046736,
            -0.9366306525410988,
            -8.879876174528086e-07,
        ],
        [
            0.43665768029177915,
            0.5378906147896932,
            -2.094373076641207e-05,
            0.020109990734459175,
            -0.3718952691709023,
            1.518324610007746e-05,
            -0.45676767102623833,
            -0.1659953456187909,
            5.7604846663346104e-06,
            -0.0,
            -0.0,
            0.0,
            -0.0,
            -0.0,
            -0.0,
            0.0,
            -0.0,
            -0.0,
        ],
        [
            0.4609641333108443,
            -0.24079588771377983,
            0.48829116070564454,
            -0.009601647555628815,
            0.17756373335860715,
            -0.3272452171530394,
            -0.0,
            0.0,
            -0.0,
            -0.4513624857552155,
            0.06323215435517268,
            -0.16104594355260515,
            -0.0,
            -0.0,
            -0.0,
            0.0,
            -0.0,
            -0.0,
        ],
        [
            0.4609661757695512,
            -0.24083398933658273,
            -0.4882704433867143,
            -0.009603016117146142,
            0.17758926796472232,
            0.32723132058954385,
            -0.0,
            0.0,
            -0.0,
            -0.0,
            -0.0,
            0.0,
            -0.45136315965240503,
            0.0632447213718604,
            0.16103912279717045,
            0.0,
            -0.0,
            -0.0,
        ],
        [
            -0.46645493622116607,
            0.3190266983950155,
            0.5453711713316096,
            0.0,
            0.0,
            0.0,
            0.23617089498667357,
            0.08581032766878122,
            -0.4159940577960087,
            0.23028404123449253,
            -0.40483702606379673,
            -0.12937711353560089,
            -0.0,
            -0.0,
            -0.0,
            0.0,
            -0.0,
            -0.0,
        ],
        [
            -0.47893085698985816,
            -0.6232478144797451,
            2.331592687687678e-05,
            0.0,
            0.0,
            0.0,
            -0.0,
            0.0,
            -0.0,
            0.2394648402104896,
            0.311634887377455,
            0.28142935543130193,
            0.23946601677936852,
            0.31161292710229016,
            -0.2814526713581788,
            0.0,
            -0.0,
            -0.0,
        ],
        [
            -0.4664512927497908,
            0.3189832015190892,
            -0.5453985934998381,
            0.0,
            0.0,
            0.0,
            0.23616847913998618,
            0.08584397853171949,
            0.41598848650602166,
            -0.0,
            -0.0,
            0.0,
            0.23028281360980465,
            -0.4048271800508087,
            0.12941010699381644,
            0.0,
            -0.0,
            -0.0,
        ],
        [
            -0.020109990750872758,
            0.371895269479796,
            3.444272090279208e-07,
            -0.49648405992217765,
            -0.5651116988131629,
            -4.872549745736358e-07,
            -0.0,
            0.0,
            -0.0,
            -0.0,
            -0.0,
            0.0,
            -0.0,
            -0.0,
            -0.0,
            0.5165940506730504,
            0.1932164293333669,
            1.42827765545715e-07,
        ],
        [
            0.03202477835099334,
            -0.592236305212791,
            -0.4390858109849597,
            -0.007240520259455062,
            0.13389964176469307,
            0.7676952977499836,
            -0.0,
            0.0,
            -0.0,
            -0.02478421847958021,
            0.4583361302526995,
            0.24942104413833974,
            -0.0,
            -0.0,
            -0.0,
            -3.9611958069032944e-08,
            5.331953984221177e-07,
            -0.5780305309033636,
        ],
        [
            1.1170609973429058,
            0.15618787705641557,
            -0.27882980328754736,
            0.0,
            0.0,
            0.0,
            -0.33090478303729615,
            -0.12024629962256966,
            0.21267824226693646,
            -0.451943837195652,
            0.08550665690916032,
            -0.14865252931370426,
            -0.3342123771099577,
            -0.12144823434300622,
            0.21480409033431516,
            0.0,
            -0.0,
            -0.0,
        ],
        [
            0.43308727786685197,
            -0.9970024739363144,
            3.980259675047393e-05,
            -0.017825173693732935,
            0.32964201010264754,
            -1.289762268210028e-05,
            -0.0,
            0.0,
            -0.0,
            -0.20763125794913811,
            0.33368408881985434,
            0.09886203603841223,
            -0.2076308462239809,
            0.3336763750138125,
            -0.09888894101248061,
            0.0,
            -0.0,
            -0.0,
        ],
        [
            -0.06999240093020379,
            1.2943736835951978,
            -2.8146299779539023e-05,
            0.2318044709269714,
            -1.3702573805479346,
            3.085640008886519e-05,
            0.05233208794168659,
            -0.9677804524365173,
            1.9307477182386415e-05,
            -0.0,
            -0.0,
            0.0,
            -0.0,
            -0.0,
            -0.0,
            -0.2141441579384542,
            1.0436641493892542,
            -2.2017577491712585e-05,
        ],
        [
            3.070534810714798e-05,
            -1.8873362616893622e-05,
            0.4882311973598261,
            -3.6130272153417046e-05,
            -2.755662315359929e-06,
            -1.524373466056574,
            -1.05770310325773e-06,
            1.972729482381929e-05,
            0.4845971651665981,
            -0.0,
            -0.0,
            0.0,
            -0.0,
            -0.0,
            -0.0,
            6.482627149526797e-06,
            1.90173010843426e-06,
            0.5515451035301497,
        ],
    ]

    if np.setdiff1d(np.array(B_ref), np.array(s_vec.B.tolist())).size:
        errors.append("Computed S-vectors do not match the reference.")

    assert not errors, "errors occured:\n{}".format("\n".join(errors))
